% Estimating viewpoint continuously to fine tune a initial matching
The NZ-WHO template matching method we have presented
(Sect.~\ref{sec:nzwho}) makes template generation and evaluation
computationally inexpensive. This means that we can use a
hypothesize-and-test scheme to efficiently explore the continuous
parameter space to find the best object pose, scale, 3D CAD model type
and camera focal length.
%
In particular, we propose to implement this parameter search as a
Markov Chain Monte Carlo (MCMC) procedure based on the
Metropolis-Hastings algorithm.

\paragraph{Probabilistic formulation.}
We parameterize the continuous parameter space as  $x = [p, m, f]$,
where $p$ is the 3D rotation of the CAD model, $m$ is the discrete CAD
model index, and $f$ is the focal length.

We model the probability that the object in the test image
$\mathcal{I}$ is generated by the parameters $x$ as a distribution in
the exponential family, and let
\begin{align}
    P(x) & \sim e^{ c_4 \max_{s} w(x) \ast \mathcal{T}_s(\mathcal{I})},
\end{align}
where $\max_{s} w(x) \ast T(\mathcal{I})$ is the convolution score of
template $w(x)$ with image feautures $T(\mathcal{I})$, as defined
in Sect.~\ref{}.

\paragraph{Inference.}
We approximate the MAP solution for $x$ by drawing samples from the
distribution $P(x)$, using the Metropolis-Hastings
algorithm. Specifically, we use a variant that changes only a single
component of the parameter vector $x$ at a time, termed Single
Component Metropolis Hastings.

As proposals

For proposal distribution, we used Gaussian distribution to propose next viewpoint and for viewpoint proposals
and uniform distribution for model change proposals.  


\begin{align}
    A(x \rightarrow x') & =  min\left( 1,  \frac{P(x' g(x') \rightarrow x)}{P(x) g(x \rightarrow x')}\right) \\
    g(x \rightarrow x + p_i') & \sim \mathcal{N}(\mu = 0,\sigma = c_1) \quad i \in \{1,2,3\}\\
    g(x \rightarrow x + f') & \sim \mathcal{N}(\mu = 0,\sigma = c_2)\\
    g(x \rightarrow x + m') & \sim c_3 \delta(m) + (1-c_3) Unif(1,M)
\end{align}


Where $g$ is the proposal distribution and $P$ is the distribution of which we
defined using Gaussian distribution around previous state. $A$ is the
acceptance probability where we accept new proposal with $A(x \rightarrow x')$.


$P$ is the distribution of the pose and location of an object on image
$\mathcal{I}$.

One can also think of the image as an image cropped by detection
bounding box. We synthesize covariance matrix and create NZ-WHO
template $w(x)$ for particular viewpoint, focal length and CAD model.



In sum, for new proposal $x'$, we make a NZ-WHO template on the fly 
We found out that it requires good initialization to converge to local minima. 


% there are several advantages that was not possible such as
% \textbf{on-the-fly} template generation and making large number of
% templates
\begin{figure}[t]
\centering
    \includegraphics[width=0.7\linewidth]{tuning2} \\ [-5pt]
    \caption{Different modes of Metropolis Hasting proposals, see Section \ref{sec:fine}}
 \label{fig:tuningmode}
\end{figure}


\paragraph{Initialization.}
To fine-tune continuous pose and location of object, we require strong
initialization. The initialization is a rough bounding box with small context
and viewpoint. Since most of the standard detectors does not provide viewpoint
of an object, we first run an ensemble of NZ-WHO templates to get rough
viewpoints. Once we get rough viewpoint, we initialize the proposal $x_0$ and
start sampling proposals.

We initialize the $x$ using the result from the previous stage where
we run our ensemble or NZ-WHO templates to get rough estimate.